# Ignition Fuel Server

# Install

1. Dependencies

    1. Go version 1.8 or above

        ```
        download and follow instructions from https://golang.org/dl/
        ```
        then
        ```
        sudo apt-get install golang-goprotobuf-dev
        ```

1. Make a workspace

    ```
    mkdir -p ~/go_ws/src
    ```

1. Download server code

    ```
    hg clone https://bitbucket.org/ignitionrobotics/ign-fuelserver ~/go_ws/src/bitbucket.org/ignitionrobotics/ign-fuelserver
    ```

1. Make the application

    ```
    cd ~/go_ws
    ```

    ```
    export GOPATH=~/go_ws
    ```

    ```
    go get bitbucket.org/ignitionrobotics/ign-fuelserver
    ```

    ```
    go install bitbucket.org/ignitionrobotics/ign-fuelserver/...
    ```
    NOTE: the `...` instructs Go to build ign-fuelserver and all its subpackages (eg. token-generator).


1. (Optional) Generate a self-signed certificate. Replace `<GO_INSTALL_PATH>` with the path to your golang installation (e.g.: `usr/local/go/`:

    ```
    cd ~/go_ws/src
    ```
    
    ```
    wget https://raw.githubusercontent.com/golang/go/release-branch.go1.8/src/crypto/tls/generate_cert.go
    ```
    
    ```
    cd ~/go_ws
    ```

    ```
    go run <GO_INSTALL_PATH>/src/generate_cert.go --host localhost --ca true
    ```

    ```
    mv cert.pem key.pem ~/go_ws/src/bitbucket.org/ignitionrobotics/ign-fuelserver/ssl
    ```

    ```
    export IGN_SSL_CERT=~/go_ws/src/bitbucket.org/ignitionrobotics/ign-fuelserver/ssl/cert.pem
    ```

    ```
    export IGN_SSL_KEY=~/go_ws/src/bitbucket.org/ignitionrobotics/ign-fuelserver/ssl/key.pem
    ```

    Note: to allow self certificates for localhost in Chrome, you need to put this in the chrome address bar : `chrome://flags/#allow-insecure-localhost`

1. Install mysql:

    ```
    sudo apt-get install mysql-server
    ```

    The installer will ask you to create a root password for mysql.

1. Create the database and a user in mysql. Replace `'newuser'` with your username and `'password'` with your new password:

    ```
    mysql -u root -p
    ```

    ```
    CREATE DATABASE fuel;
    ```

    Also create a separate database to use with tests:

    ```
    CREATE DATABASE fuel_test;
    ```

    ```
    CREATE USER 'newuser'@'localhost' IDENTIFIED BY 'password';
    ```

    ```
    GRANT ALL PRIVILEGES ON fuel.* TO 'newuser'@'localhost';
    ```

    ```
    FLUSH PRIVILEGES;
    ```

    ```
    exit
    ```

1. Create a Test JWT token (this is needed for tests to pass OK -- `go test`)

    TL;DR: Just copy and paste the following env vars in your system (`.env`)

        # Test RSA256 Private key WITHOUT the -----BEGIN RSA PRIVATE KEY----- and -----END RSA PRIVATE KEY-----
        # It is used by token-generator to generate the Test JWT Token
        export TOKEN_GENERATOR_PRIVATE_RSA256_KEY=MIICWwIBAAKBgQDdlatRjRjogo3WojgGHFHYLugdUWAY9iR3fy4arWNA1KoS8kVw33cJibXr8bvwUAUparCwlvdbH6dvEOfou0/gCFQsHUfQrSDv+MuSUMAe8jzKE4qW+jK+xQU9a03GUnKHkkle+Q0pX/g6jXZ7r1/xAK5Do2kQ+X5xK9cipRgEKwIDAQABAoGAD+onAtVye4ic7VR7V50DF9bOnwRwNXrARcDhq9LWNRrRGElESYYTQ6EbatXS3MCyjjX2eMhu/aF5YhXBwkppwxg+EOmXeh+MzL7Zh284OuPbkglAaGhV9bb6/5CpuGb1esyPbYW+Ty2PC0GSZfIXkXs76jXAu9TOBvD0ybc2YlkCQQDywg2R/7t3Q2OE2+yo382CLJdrlSLVROWKwb4tb2PjhY4XAwV8d1vy0RenxTB+K5Mu57uVSTHtrMK0GAtFr833AkEA6avx20OHo61Yela/4k5kQDtjEf1N0LfI+BcWZtxsS3jDM3i1Hp0KSu5rsCPb8acJo5RO26gGVrfAsDcIXKC+bQJAZZ2XIpsitLyPpuiMOvBbzPavd4gY6Z8KWrfYzJoI/Q9FuBo6rKwl4BFoToD7WIUS+hpkagwWiz+6zLoX1dbOZwJACmH5fSSjAkLRi54PKJ8TFUeOP15h9sQzydI8zJU+upvDEKZsZc/UhT/SySDOxQ4G/523Y0sz/OZtSWcol/UMgQJALesy++GdvoIDLfJX5GBQpuFgFenRiRDabxrE9MNUZ2aPFaFp+DyAe+b4nDwuJaW2LURbr8AEZga7oQj0uYxcYw==

        # JWT Token generated by the token-generator program using the above Test RSA keys
        # This token does not expire.
        export IGN_TEST_JWT=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXItaWRlbnRpdHkifQ.iV59-kBkZ86XKKsph8fxEeyxDiswY1zvPGi4977cHbbDEkMA3Y3t_zzmwU4JEmjbTeToQZ_qFNJGGNufK2guLy0SAicwjDmv-3dHDfJUH5x1vfi1fZFnmX_b8215BNbCBZU0T2a9DEFypxAQCQyiAQDE9gS8anFLHHlbcWdJdGw

        # A Test RSA256 Public key, without the -----BEGIN CERTIFICATE----- and -----END CERTIFICATE-----.
        # It is used to override the AUTH0_RSA256_PUBLIC_KEY when tests are run.
        export TEST_RSA256_PUBLIC_KEY=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDdlatRjRjogo3WojgGHFHYLugdUWAY9iR3fy4arWNA1KoS8kVw33cJibXr8bvwUAUparCwlvdbH6dvEOfou0/gCFQsHUfQrSDv+MuSUMAe8jzKE4qW+jK+xQU9a03GUnKHkkle+Q0pX/g6jXZ7r1/xAK5Do2kQ+X5xK9cipRgEKwIDAQAB

    Long version:

    Ign Fuel assumes JWT Tokens are RSA256. In order to generate the token, follow these steps:

    1. You need to set the `TOKEN_GENERATOR_PRIVATE_RSA256_KEY` env var first. This var is a RSA256 Private key without the `-----BEGIN RSA PRIVATE KEY-----` and `-----END RSA PRIVATE KEY-----` prefix and suffix. It is used to generate Test JWT Tokens.

    1. Also please write down the corresponding `TEST_RSA256_PUBLIC_KEY` env var. This var is the RSA256 Public key (without the `-----BEGIN CERTIFICATE-----` and `-----END CERTIFICATE-----`) that will be used by the backend to validate received Test JWT tokens. NOTE: This one must be the pair of the private key `TOKEN_GENERATOR_PRIVATE_RSA256_KEY`.

    1. Generate the token:

        Build all ign-fuelserver packages and programs:

            go install bitbucket.org/ignitionrobotics/ign-fuelserver/...

        Note: the `...` instructs Go to build ign-fuelserver and all subpackages (eg. token-generator. You can find the extra packages in cmd/ subfolder).

            bin/token-generator

    1. The token-generator program will output a signed token. You will need to set the `IGN_TEST_JWT` env var with that generated value.

    In summary, in order to make `go test` work with JWT you will need to set the following env vars:

    * `TOKEN_GENERATOR_PRIVATE_RSA256_KEY`
    * `TEST_RSA256_PUBLIC_KEY`
    * `IGN_TEST_JWT`


1. Run the test suite

    First, make sure you have all the required env variables set:

    ```
    export IGN_DB_USERNAME=<DB username>
    ```

    ```
    export IGN_DB_PASSWORD=<DB password>
    ```

    ```
    export IGN_DB_ADDRESS=<DB IP and port. Eg: localhost:3306>
    ```

    ```
    export IGN_DB_NAME=<Databse name>
    ```

    ```
    export IGN_TEST_JWT=<JWT token>
    ```

    ```
    export TEST_RSA256_PUBLIC_KEY=< RSA256 public key without the '-----BEGIN CERTIFICATE-----' and '-----END CERTIFICATE-----'>
    Note: TEST_RSA256_PUBLIC_KEY must be able to decode and validate the IGN_TEST_JWT test token.
    ```

    Then, run all tests:
    ```
    go test bitbucket.org/ignitionrobotics/ign-fuelserver
    ```

1. Run the backend server

    First, make sure to set the `AUTH0_RSA256_PUBLIC_KEY` environment variable with the Auth0 RSA256 public key. This env var will be used by the backend to decode and validate any received Auth0 JWT tokens.
    Note: You can get this key from: <https://osrf.auth0.com/.well-known/jwks.json> (or from your own auth0 user). Open that url in the browser and copy the value of the `x5c` field.

    ```
    ./bin/ign-fuelserver
    ```

1. Test in the browser

   1. If using SSL

       ```
       https://localhost:4430/1.0/models
       ```

   1. If **not** using SSL

       ```
       http://localhost:8000/1.0/models
       ```

# Environment Variables

You may want to create an `.env.bash` file to define environment vars. Remember to add it to `.hgignore`.
Then load the env vars using `$source .env.bash` from the bash terminal where you will run go commands.

## Database

There are three databases in use:

  1. *ign-fuel*: a production database for use with the production Elastic Beanstalk environment,
    
  2. *ign-fuel-staging*: a staging database for use with the staging Elastic Beanstalk environment, and
    
  3. *ign-fuel-integration*: an integration database for use with the integration Elastic Beanstalk environment.

The production database should *never* be manually altered. The staging
database should match the production environment, and the purpose is to
catch migration errors on the staging Elastic beanstalk instance. The
integration database is used during testing and development. This database
is frequently wiped and altered.

* Environment variables*

1. `IGN_DB_USERNAME` : Mysql user name.
1. `IGN_DB_PASSWORD` : Mysql user password.
1. `IGN_DB_ADDRESS` : Mysql address, of the form `host:port`.
1. `IGN_DB_NAME` : Mysql databased name.
1. `AUTH0_RSA256_PUBLIC_KEY` : Auth0 RSA256 public key without the '-----BEGIN CERTIFICATE-----' and '-----END CERTIFICATE-----'
    Note: You can get this key from: <https://osrfoundation.auth0.com/.well-known/jwks.json> (or from your auth0 user). It is the "x5c" field.

## Testing and Development

1. `IGN_TEST_JWT` : A JWT token used from unit tests. Note: the `TEST_RSA256_PUBLIC_KEY` must be able to decode and validate this test token.

1. `TEST_RSA256_PUBLIC_KEY` :  if present, override the Auth0 public RSA key with this test key. This one must match with the Test JWT token. It is used by unit tests (`go test`).

1. `TOKEN_GENERATOR_PRIVATE_RSA256_KEY` : RSA 256 private key Used by the Token Generator utility program to generate the Test JWT token. It must pair with the `TEST_RSA256_PUBLIC_KEY` public key.  


# Naming conventions

In general we will try to follow Go naming conventions. In addition, these are own conventions:

1. For constructors / factory-methods we will use the form: `New<object>`.  See: <http://www.golangpatterns.info/object-oriented/constructors>

1. For HTTP POST handlers we use: `<object>Create`. eg: ModelCreate.
1. For HTTP DELETE handlers we use: `<object>Remove`. eg: ModelRemove.
1. An HTTP handler that returns a collection will have the form: `<object>List<format>`. eg: ModelListJSON.
    Note: `format` is optional. JSON will be assumed by default.
1. An HTTP handler that returns a single element will be: `<object>Index<format>`. eg: ModelIndexZip.
    Note: `format` is optional.  JSON will be assumed by default.
1. For HTTP OPTIONS handler we use: `<object>API`.
1. We use the func suffix `Impl` when we delegate implementation of a handler to an internal function. Eg: UserCreate handler can delegate to userCreateImpl. 

# Linter

1. Get the linter

    ```
    cd ~/go_ws
    ```

    ```
    go get -u github.com/golang/lint/golint
    ```

1. Run the linter

    ```
    ./bin/golint bitbucket.org/ignitionrobotics/ign-fuelserver
    ```

# Proto

1. If you need to modify the proto files then you will need to
run (from the proto folder):

    ```
    protoc --go_out=. *.proto
    ```

    Then update the generated import proto from code.google... to "github.com/golang/protobuf/proto"


# Coverage

1. Run test suite with coverage enabled

    ```
    go test -cover bitbucket.org/ignitionrobotics/ign-fuelserver
    ```
    
# Integration deployment

If it's the first time that you deploy on `integration`:
  
1. [Install eb CLI tool](http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3-install.html) (if needed).
  
1. Configure eb:
  
    ```
    eb init
    ```
     
    And choose the following options: 
     
    1. Select `us-east-1` as region.
       
    1. Select `ign-fuel-server` as the application name.
       
    1. Select `ign-fuel-server-integration` as the environment name.
       
Otherwise, just type:

    eb deploy
    

# Staging/Production deployment

The `staging` and `production` branches push code through bitbucket
pipelines to AWS Elastic Beanstalk (EBS).

1. Push code to staging. Make sure pipelines completes successfully.

1. Test `staging.api.ignitionfuel.org`

1. When ready, Swap Environment URLs with the production EBS environment.

1. Merge the `staging` branch into the `production` branch, and push.

1. Test `staging.api.ignitionfuel.org` again

1. Swap the EBS environment URLs back.

# AWS Configuration

* Elastic Beanstalk runs go in a docker container

* AWS Relation Database (RDS) runs an instance of mysql.

* Each EC2 instance started by EBS mounts an NFS filesystem, via Elastic
Filesystem, on `/fuel`. This filesystem store all the mercurial
repositories.

## AWS RDS

There are two mysql databases hosted on Amazon.

1. `ign-fuel`: The production database.

    * Endpoint: ign-fuel.cpznmiopbczj.us-east-1.rds.amazonaws.com:3306

1. `ign-fuel-dev`: The development and testing database. You can write tests that will run on bitbucket pipelines against this database. Make sure to clean the database up after each test.

    * Endpoint: ign-fuel-dev.cpznmiopbczj.us-east-1.rds.amazonaws.com:3306

# Development

See the Database section above for information on the different database
options.

## REST Documentation

Swagger is used to document the REST API. This includes both model and
route information.

**Do not manually edit `swagger.json`**

**Process**

1. Document a route or model following [this documentation](https://goswagger.io/generate/spec.html).

1. Install swagger inside your `GOPATH`

    * go get -u github.com/go-swagger/go-swagger/cmd/swagger
    * go install github.com/go-swagger/go-swagger/cmd/swagger

1. Generate the `swagger.json` file. This file will be used by a webserver
   to display the API documentation.

    ```
    ./bin/swagger generate spec -o ./src/bitbucket.org/ignitionrobotics/ign-fuelserver/swagger.json -b ./src/bitbucket.org/ignitionrobotics/ign-fuelserver/ -m
    ```

1. Commit and push your changes to the repository.

1. View the results at [http://doc.ignitionfuel.org](http://doc.ignitionfuel.org). Enter
   a new `swagger.json` in the `Explore` box to see a different version of
   the API.

**Useful links**

1. [Swagger json documentation](https://goswagger.io/generate/spec.html)

  * This page documents how to write swagger documentation that will be
  parsed to generate the swagger.json file.

1. [Our S3 swagger website](http://doc.ignitionfuel.org)

  * This is an instance of [swagger-ui](https://github.com/swagger-api/swagger-ui/tree/master/dist), where the `index.html` file was edited to point to our swagger file.
